<script>
    var timeline = []; //array with every stage of the experiment.
    var duration = 1000; //trial duration
    var welcome = {
        type: "html-keyboard-response", stimulus: "Welcome",
    };
    timeline.push(welcome);
    var instructions = {
        type: "html-keyboard-response", stimulus: "Hello Instructions",
    };
    timeline.push(instructions);
    var fix = {
        type: 'canvas-keyboard-response',
        stimulus: function(c) {
            fixation(c);
        },
        trial_duration: 500, choices: jsPsych.NO_KEYS,
    };
    //Correct resp for reward state 1
    //r1_50 list of correct responses and shuffle function shuffles the order of the elements.
    var r1_60 = [37, 39, 37, 39, 37, 39, 37, 37, 37, 39]; var rand60r1 = shuffle(r1_60);
    var r1_90 = [37, 39, 37, 37, 37, 37, 37, 37, 37, 37]; var rand90r1 = shuffle(r1_90);
    //Correct resp for reward state 2
    var r2_60 = [39, 39, 39, 39, 37, 39, 37, 37, 37, 39]; var rand60r2 = shuffle(r2_60);
    var r2_90 = [39, 39, 39, 39, 39, 39, 39, 39, 39, 37]; var rand90r2 = shuffle(r2_90);

    var practicetrial = { //Practice block
        type: 'canvas-keyboard-response',
        on_start: function(practicetrial){ //generates a random contrast level after every trial and it acts as input in the gabor function
            practicetrial.contrast = Math.random(); practicetrial.contrast1 = jsPsych.currentTrial().contrast  + randbet(0.05,0.35);
        },
        stimulus: function(c) {
            gabor(c);
        },
        data: {
            condition: '50_50',
        },
        choices: [37,39],
        trial_duration: duration,
        on_finish: function (data) {
            if (data.key_press === rand50r1.pop()) {
                data.correct = true;
            } else {
                data.correct = false;
            }
        },
    };
    var fb = {
        type: 'html-keyboard-response', choices: jsPsych.NO_KEYS, trial_duration: duration,
        stimulus: function () {
            var last_trial_correct = jsPsych.data.get().last(1).values()[0].correct;
            if (last_trial_correct) {
                return "<p style=\"font-size: 30px;color: #016901\">You win 1 point!</p>";
            } else {
                return "<p style=\"font-size: 30px;color: #ba0000\">You win 0 points!</p>"
            }
        }
    };
    var practiceblock = {
        timeline: [fix, practicetrial, fb], repetitions: 10, randomize_order: true
    };
    // High Perceptual Uncertainty and High Reward Uncertainty
    var s0_r1_high60 = {
        type: 'canvas-keyboard-response',
        on_start: function(s0_r1_high60){
            s0_r1_high60.contrast = Math.random(); s0_r1_high60.contrast1 = jsPsych.currentTrial().contrast  + randbet(0.05,0.35);
        },
        stimulus: function(c) {
            gabor(c);
        },
        data: {
            condition: 'HH', state: '0', reward: '1', prob: '60_40'
        },
        choices: [37,39], trial_duration: duration,
        on_finish: function (data) {
            if (data.key_press === rand60r1.pop()) {
                data.correct = true;
            } else {
                data.correct = false;
            }
        },
    };
    // High Perceptual Uncertainty and Low Reward Uncertainty
    var s0_r1_high90 = {
        type: 'canvas-keyboard-response',
        on_start: function(s0_r1_high90){
            s0_r1_high90.contrast = Math.random(); s0_r1_high90.contrast1 = jsPsych.currentTrial().contrast  + randbet(0.05,0.35);
        },
        stimulus: function(c) {
            gabor(c);
        },
        data: {
            condition: 'HL', state: '0', reward: '1', prob: '90_10',
        },
        choices: [37,39],
        trial_duration: duration,
        on_finish: function (data) {
            if (data.key_press === rand90r1.pop()) {
                data.correct = true;
            } else {
                data.correct = false;
            }
        },
    };
    // Low PU and High RU
    var s0_r1_low60 = {
        type: 'canvas-keyboard-response',
        on_start: function(s0_r1_low60){
            s0_r1_low60.contrast = Math.random(); s0_r1_low60.contrast1 = jsPsych.currentTrial().contrast  + randbet(0.5,0.9);
        },
        stimulus: function(c) {
            gabor(c);
        },
        data: {
            condition: 'LH', state: '0', reward: '1', prob: '60_40',
        },
        choices: [37,39],
        trial_duration: duration,
        on_finish: function (data) {
            if (data.key_press === rand60r1.pop()) {
                data.correct = true;
            } else {
                data.correct = false;
            }
        },
    };
    // Low PU and Low RU
    var s0_r1_low90 = {
        type: 'canvas-keyboard-response',
        on_start: function(s0_r1_low90){
            s0_r1_low90.contrast = Math.random(); s0_r1_low90.contrast1 = jsPsych.currentTrial().contrast  + randbet(0.5,0.9);
        },
        stimulus: function(c) {
            gabor(c);
        },
        data: {
            condition: 'LL', state: '0', reward: '1', prob: '90_10',
        },
        choices: [37,39],
        trial_duration: duration,
        on_finish: function (data) {
            if (data.key_press === rand90r1.pop()) {
                data.correct = true;
            } else {
                data.correct = false;
            }
        },
    };

    var s0_r1_hh60 = {
        timeline: [fix, s0_r1_high60, fb],
        repetitions: 1,
        randomize_order: true
    };
    var block1 = {
        type: "html-keyboard-response",
        stimulus: "HH",
    };
    var s0_r1_hl90 = {
        timeline: [fix, s0_r1_high90, fb],
        repetitions: 3,
        randomize_order: true
    };
    var block2 = {
        type: "html-keyboard-response",
        stimulus: "HL",
    };
    var s0_r1_lh60 = {
        timeline: [fix, s0_r1_low60, fb],
        repetitions: 3,
        randomize_order: true
    };
    var block3 = {
        type: "html-keyboard-response",
        stimulus: "LH",
    };
    var s0_r1_ll90 = {
        timeline: [fix, s0_r1_low90, fb],
        repetitions: 3,
        randomize_order: true
    };
    var block4 = {
        type: "html-keyboard-response",
        stimulus: "LL",
    };


    // High PU and High RU
    var s0_r2_high60 = {
        type: 'canvas-keyboard-response',
        on_start: function(s0_r2_high60){
            s0_r2_high60.contrast = Math.random(); s0_r2_high60.contrast1 = jsPsych.currentTrial().contrast  + randbet(0.05,0.35);
        },
        stimulus: function(c) {
            gabor(c);
        },
        data: {
            condition: 'HH', state: '0', reward: '2', prob: '40_60',
        },
        choices: [37,39],
        trial_duration: duration,
        on_finish: function (data) {
            if (data.key_press === rand60r2.pop()) {
                data.correct = true;
            } else {
                data.correct = false;
            }
        },
    };
    // High PU and Low RU
    var s0_r2_high90 = {
        type: 'canvas-keyboard-response',
        on_start: function(s0_r2_high90){
            s0_r2_high90.contrast = Math.random(); s0_r2_high90.contrast1 = jsPsych.currentTrial().contrast  + randbet(0.05,0.35);
        },
        stimulus: function(c) {
            gabor(c);
        },
        data: {
            condition: 'HL', state: '0', reward: '2', prob: '10_90',
        },
        choices: [37,39],
        trial_duration: duration,
        on_finish: function (data) {
            if (data.key_press === rand90r2.pop()) {
                data.correct = true;
            } else {
                data.correct = false;
            }
        },
    };
    // Low PU and High RU
    var s0_r2_low60 = {
        type: 'canvas-keyboard-response',
        on_start: function(s0_r2_low60){
            s0_r2_low60.contrast = Math.random(); s0_r2_low60.contrast1 = jsPsych.currentTrial().contrast  + randbet(0.5,0.9);
        },
        stimulus: function(c) {
            gabor(c);
        },
        data: {
            condition: 'HL', state: '0', reward: '2', prob: '40_60',
        },
        choices: [37,39],
        trial_duration: duration,
        on_finish: function (data) {
            if (data.key_press === rand60r2.pop()) {
                data.correct = true;
            } else {
                data.correct = false;
            }
        },
    };
    // Low PU and Low RU
    var s0_r2_low90 = {
        type: 'canvas-keyboard-response',
        on_start: function(s0_r2_low90){
            s0_r2_low90.contrast = Math.random(); s0_r2_low90.contrast1 = jsPsych.currentTrial().contrast  + randbet(0.5,0.9);
        },
        stimulus: function(c) {
            gabor(c);
        },
        data: {
            condition: 'LL', state: '0', reward: '2', prob: '10_90',
        },
        choices: [37,39],
        trial_duration: duration,
        on_finish: function (data) {
            if (data.key_press === rand90r2.pop()) {
                data.correct = true;
            } else {
                data.correct = false;
            }
        },
    };
    var s0_r2_hh60 = {
        timeline: [fix, s0_r2_high60, fb],
        repetitions: 3,
        randomize_order: true
    };
    var s0_r2_hl90 = {
        timeline: [fix, s0_r2_high90, fb],
        repetitions: 3,
        randomize_order: true
    };
    var s0_r2_lh60 = {
        timeline: [fix, s0_r2_low60, fb],
        repetitions: 3,
        randomize_order: true
    };
    var s0_r2_ll90 = {
        timeline: [fix, s0_r2_low90, fb],
        repetitions: 3,
        randomize_order: true
    };
    // High PU and High RU
    var s1_r1_high60 = {
        type: 'canvas-keyboard-response',
        on_start: function(s1_r1_high60){
            s1_r1_high60.contrast = Math.random(); s1_r1_high60.contrast1 = jsPsych.currentTrial().contrast  - randbet(0.05,0.35);
        },
        stimulus: function(c) {
            gabor(c);
        },
        data: {
            condition: 'HH', state: '1', reward: '1', prob: '60_40',
        },
        choices: [37,39],
        trial_duration: duration,
        on_finish: function (data) {
            if (data.key_press === rand60r1.pop()) {
                data.correct = true;
            } else {
                data.correct = false;
            }
        }
    };
    // High PU and Low RU
    var s1_r1_high90 = {
        type: 'canvas-keyboard-response',
        on_start: function(s1_r1_high90){
            s1_r1_high90.contrast = Math.random(); s1_r1_high90.contrast1 = jsPsych.currentTrial().contrast  - randbet(0.05,0.35);
        },
        stimulus: function(c) {
            gabor(c);
        },
        data: {
            condition: 'LH', state: '1', reward: '1', prob: '90_10',
        },
        choices: [37,39],
        trial_duration: duration,
        on_finish: function (data) {
            if (data.key_press === rand90r1.pop()) {
                data.correct = true;
            } else {
                data.correct = false;
            }
        },
    };
    // Low PU and High RU
    var s1_r1_low60 = {
        type: 'canvas-keyboard-response',
        on_start: function(s1_r1_low60){
            s1_r1_low60.contrast = Math.random(); s1_r1_low60.contrast1 = jsPsych.currentTrial().contrast  - randbet(0.5,0.9);
        },
        stimulus: function(c) {
            gabor(c);
        },
        data: {
            condition: 'LH', state: '1', reward: '1', prob: '60_40',
        },
        choices: [37,39],
        trial_duration: duration,
        on_finish: function (data) {
            if (data.key_press === rand60r1.pop()) {
                data.correct = true;
            } else {
                data.correct = false;
            }
        },
    };
    // Low PU and Low RU
    var s1_r1_low90 = {
        type: 'canvas-keyboard-response',
        on_start: function(s1_r1_low90){
            s1_r1_low90.contrast = Math.random(); s1_r1_low90.contrast1 = jsPsych.currentTrial().contrast  - randbet(0.5,0.9);
        },
        stimulus: function(c) {
            gabor(c);
        },
        data: {
            condition: 'LL', state: '1', reward: '1', prob: '90_10',
        },
        choices: [37,39],
        trial_duration: duration,
        on_finish: function (data) {
            if (data.key_press === rand90r1.pop()) {
                data.correct = true;
            } else {
                data.correct = false;
            }
        },
    };

    var s1_r1_hh60 = {
        timeline: [fix, s1_r1_high60, fb],
        repetitions: 3,
        randomize_order: true
    };
    var s1_r1_hl90 = {
        timeline: [fix, s1_r1_high90, fb],
        repetitions: 3,
        randomize_order: true
    };
    var s1_r1_lh60 = {
        timeline: [fix, s1_r1_low60, fb],
        repetitions: 3,
        randomize_order: true
    };
    var s1_r1_ll90 = {
        timeline: [fix, s1_r1_low90, fb],
        repetitions: 3,
        randomize_order: true
    };
    // High PU and High RU
    var s1_r2_high60 = {
        type: 'canvas-keyboard-response',
        on_start: function(practicetrial){
            practicetrial.contrast = Math.random(); practicetrial.contrast1 = jsPsych.currentTrial().contrast  - randbet(0.05,0.35);
        },
        stimulus: function(c) {
            gabor(c);
        },
        data: {
            condition: 'HH', state: '1', reward: '2', prob: '40_60',
        },
        choices: [37,39],
        trial_duration: duration,
        on_finish: function (data) {
            if (data.key_press === rand60r2.pop()) {
                data.correct = true;
            } else {
                data.correct = false;
            }
        },
    };
    // High PU and Low RU
    var s1_r2_high90 = {
        type: 'canvas-keyboard-response',
        on_start: function(practicetrial){
            practicetrial.contrast = Math.random(); practicetrial.contrast1 = jsPsych.currentTrial().contrast  - randbet(0.05,0.35);
        },
        stimulus: function(c) {
            gabor(c);
        },
        data: {
            condition: 'HL', state: '1', reward: '2', prob: '10_90',
        },
        choices: [37,39],
        trial_duration: duration,
        on_finish: function (data) {
            if (data.key_press === rand90r2.pop()) {
                data.correct = true;
            } else {
                data.correct = false;
            }
        },
    };
    // Low PU and High RU
    var s1_r2_low60 = {
        type: 'canvas-keyboard-response',
        on_start: function(practicetrial){
            practicetrial.contrast = Math.random(); practicetrial.contrast1 = jsPsych.currentTrial().contrast  - randbet(0.5,0.9);
        },
        stimulus: function(c) {
            gabor(c);
        },
        data: {
            condition: 'LH', state: '1', reward: '2', prob: '40_60',
        },
        choices: [37,39],
        trial_duration: duration,
        on_finish: function (data) {
            if (data.key_press === rand60r2.pop()) {
                data.correct = true;
            } else {
                data.correct = false;
            }
        },
    };
    // Low PU and Low RU
    var s1_r2_low90 = {
        type: 'canvas-keyboard-response',
        on_start: function(practicetrial){
            practicetrial.contrast = Math.random(); practicetrial.contrast1 = jsPsych.currentTrial().contrast  - randbet(0.5,0.9);
        },
        stimulus: function(c) {
            gabor(c);
        },
        data: {
            condition: 'LL', state: '1', reward: '2', prob: '10_90',
        },
        choices: [37,39],
        trial_duration: duration,
        on_finish: function (data) {
            if (data.key_press === rand90r2.pop()) {
                data.correct = true;
            } else {
                data.correct = false;
            }
        },
    };

    var s1_r2_hh60 = {
        timeline: [fix, s1_r2_high60, fb],
        repetitions: 3,
        randomize_order: true
    };
    var s1_r2_hl90 = {
        timeline: [fix, s1_r2_high90, fb],
        repetitions: 3,
        randomize_order: true
    };
    var s1_r2_lh60 = {
        timeline: [fix, s1_r2_low60, fb],
        repetitions: 3,
        randomize_order: true
    };
    var s1_r2_ll90 = {
        timeline: [fix, s1_r2_low90, fb],
        repetitions: 3,
        randomize_order: true
    };
    var end = {
        type: "html-keyboard-response",
        stimulus: "Bye",
    };
    timeline.push(practiceblock);
    //hh
    timeline.push(block1);
    timeline.push(s0_r1_hh60);
    timeline.push(block2);
    timeline.push(s1_r1_hh60);
    timeline.push(block3);
    timeline.push(s0_r2_hh60);
    timeline.push(block4);
    timeline.push(s1_r2_hh60)
    //hl
    timeline.push(block1);
    timeline.push(s1_r1_hl90);
    timeline.push(block2);
    timeline.push(s1_r2_hl90);
    timeline.push(block3);
    timeline.push(s0_r1_hl90);
    timeline.push(block4);
    timeline.push(s0_r2_hl90);
    //lh
    timeline.push(block1);
    timeline.push(s1_r1_lh60);
    timeline.push(block2);
    timeline.push(s0_r2_lh60);
    timeline.push(block3);
    timeline.push(s0_r1_lh60);
    timeline.push(block4);
    timeline.push(s1_r2_lh60);
    //ll
    timeline.push(block1);
    timeline.push(s0_r2_ll90);
    timeline.push(block2);
    timeline.push(s0_r1_ll90);
    timeline.push(block3);
    timeline.push(s1_r2_ll90);
    timeline.push(block4);
    timeline.push(s1_r1_ll90);
    timeline.push(end);

    jsPsych.init({
        timeline: timeline,
        on_finish: function() {
            jsPsych.data.displayData();
        }
    });
</script>
