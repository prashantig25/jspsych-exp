<script>
   var timeline = []; //array with every stage of the experiment.
   var duration = 1000; //trial duration
   var keys = [37, 39]; // key presses allowed when the stimulus is presented to the participants
   
   //Correct resp for reward state 1
   //r1_60 list of correct responses and shuffle function shuffles the order of the elements.
   var r1_60 = [37, 39, 37, 39, 37, 39, 37, 37, 37, 39, 37, 39, 37, 39, 37, 39, 37, 37, 37, 39]; var rand60r1 = shuffle(r1_60);
   var r1_90 = [37, 39, 37, 37, 37, 37, 37, 37, 37, 37, 37, 39, 37, 37, 37, 37, 37, 37, 37, 37]; var rand90r1 = shuffle(r1_90);
   //Correct resp for reward state 2
   var r2_60 = [39, 39, 39, 39, 37, 39, 37, 37, 37, 39, 39, 39, 39, 39, 37, 39, 37, 37, 37, 39]; var rand60r2 = shuffle(r2_60);
   var r2_90 = [39, 39, 39, 39, 39, 39, 39, 39, 39, 37, 39, 39, 39, 39, 39, 39, 39, 39, 39, 37]; var rand90r2 = shuffle(r2_90);
    
   var welcome = {
        type: "html-keyboard-response", stimulus: "<p style=\"font-size: 20px;color: #000000\"> Welcome to the study. Press any key to process forward.</p>",
    };
    var fix = {
        type: 'canvas-keyboard-response', stimulus: fixation, trial_duration: 500, choices: jsPsych.NO_KEYS, data: { condition: 'fixation'},
    };
    var highprac_instruct = {
        type: "html-keyboard-response", stimulus: "<p style=\"font-size: 20px;color: #000000\"> Here are the instructions for the task.</p>" +
            "<p style=\"font-size: 20px;color: #000000\"> Before you do the actual task, please take part in the practice blocks. In these practice blocks, trials will begin with a fixation cross. In each trial, you will be presented with two images. Both images may have different levels of brightness on each trial. Your task is to choose the image which higher contrast level. If the image on your left has higher contrast level, press the <strong> left arrow </strong>. If the image on your right has higher contrast level, press the <strong> right arrow </strong>.</p>" +
            "<p> If you have understood the instructions, please press any key to proceed.</p>"
    };
    var lowprac_instruct = {
        type: "html-keyboard-response", stimulus: "<p style=\"font-size: 20px;color: #000000\"> Here are the instructions for the task.</p>" +
            "<p style=\"font-size: 20px;color: #000000\"> Before you do the actual task, please take part in the practice blocks. In these practice blocks, trials will begin with a fixation cross. In each trial, you will be presented with two images. Both images may have different levels of brightness on each trial. Your task is to choose the image which lower contrast level. If the image on your left has lower contrast level, press the <strong> left arrow </strong>. If the image on your right has lower contrast level, press the <strong> right arrow </strong>.</p>" +
            "<p> If you have understood the instructions, please press any key to proceed.</p>"
    };
    var prac_highPU_s0 = {
        type: 'canvas-keyboard-response',
        on_start: function(prac_highPU_s0){ //generates a random contrast level after every trial and it acts as input in the gabor function
            prac_highPU_s0.contrast = Math.random(); prac_highPU_s0.contrast1 = jsPsych.currentTrial().contrast  + randbet(0.05,0.35);
        },
        stimulus: gabor, choices: keys, trial_duration: duration, response_ends_trial: false,
        data: {con: jsPsych.currentTrial().contrast}
    };
    var prac_highPU_s1 = {
        type: 'canvas-keyboard-response',
        on_start: function(prac_highPU_s1){ //generates a random contrast level after every trial and it acts as input in the gabor function
            prac_highPU_s1.contrast = Math.random(); prac_highPU_s1.contrast1 = jsPsych.currentTrial().contrast - randbet(0.05,0.35);
        },
        stimulus: gabor, choices: keys, trial_duration: duration, response_ends_trial: false,
    };
    var prac_lowPU_s0 = {
        type: 'canvas-keyboard-response',
        on_start: function(prac_lowPU_s0){ //generates a random contrast level after every trial and it acts as input in the gabor function
            prac_lowPU_s0.contrast = Math.random(); prac_lowPU_s0.contrast1 = jsPsych.currentTrial().contrast  + randbet(0.4,0.9);
        },
        stimulus: gabor, choices: keys, trial_duration: duration, response_ends_trial: false,
    };
    var prac_lowPU_s1 = {
        type: 'canvas-keyboard-response',
        on_start: function(prac_lowPU_s1){ //generates a random contrast level after every trial and it acts as input in the gabor function
            prac_lowPU_s1.contrast = Math.random(); prac_lowPU_s1.contrast1 = jsPsych.currentTrial().contrast - randbet(0.4,0.9);
        },
        stimulus: gabor, choices: keys, trial_duration: duration, response_ends_trial: false,
    };
    var stim_high_s1_prac = { timeline: [fix, prac_highPU_s0] };
    var stim_high_s0_prac = { timeline: [fix, prac_highPU_s1] };
    var stim_low_s1_prac = { timeline: [fix, prac_lowPU_s1] };
    var stim_low_s0_prac = { timeline: [fix, prac_lowPU_s0] };
    var practice_block = {
        timeline: [stim_high_s1_prac, stim_high_s0_prac, stim_low_s0_prac, stim_low_s1_prac], repetitions: 1, randomize_order: true
    };
    var prac_block = {
        type: "html-keyboard-response", stimulus: "<p style=\"font-size: 20px;color: #000000\"> Practice Block will begin now. Press any key to start the practice block.</p>",
    };
    var instructions = {
        type: "html-keyboard-response", stimulus: "<p style=\"font-size: 20px;color: #000000\"> Here are the instructions for the main task.</p>" +
            "<p style=\"font-size: 20px;color: #000000\"> In this task, you will be presented with multiple blocks of trials. A fixation cross (+) will precede each trial. Please fixate on the cross before the start of the trial."+
            "In each trial, you will be presented with two images. Both images may have different levels of brightness on each trial. Your task is to choose one of these two images."+
            "<br> If you want to choose the image presented on your left, please press the <strong>left arrow </strong> on your keyboard. <br>If you want to choose the image presented on your right, press the <strong>right arrow </strong>on your keyboard.<br>"+
            " Your main aim is to figure out which image you should choose, given the relationship between the contrast levels of either images with winning 1 or 0 points on that trial."+
            " This relationship may change when a new block of trials starts. You will learn this relationship from feedback after your choice. That is, after each trial, you will be presented with the points you win on that trial."+
            " You should try to maximize your winnings on each trial." +
            "<p> If you have understood the instructions, please press any key to proceed to with the experiment.</p>"
    };
    var fb = {
        type: 'html-keyboard-response', choices: jsPsych.NO_KEYS, trial_duration: duration,
        stimulus: function () {
            var last_trial_correct = jsPsych.data.get().last(1).values()[0].correct;
            if (last_trial_correct) {
                return "<p style=\"font-size: 30px;color: #016901\">You win 1 point!</p>";
            } else {
                return "<p style=\"font-size: 30px;color: #ba0000\">You win 0 points!</p>"
            }
        }
    };
    var block1 = {
        type: "html-keyboard-response",
        stimulus: "Next block begins now",
    };
    
    //Stimulus presentations
    // High Perceptual and Reward Uncertainty
    var s0_r1_high60 = {
        type: 'canvas-keyboard-response',
        on_start: function(s0_r1_high60){
            s0_r1_high60.contrast = Math.random(); s0_r1_high60.contrast1 = jsPsych.currentTrial().contrast  + randbet(0.05,0.35);
        },
        stimulus: gabor,
        data: {
            condition: 'HH', state: '0', reward: '1', prob: '60_40',
        },
        choices: keys, trial_duration: duration,response_ends_trial: false,
        on_finish: function (data) {
            if (data.key_press === rand60r1.pop()) {
                data.correct = true;
            } else {
                data.correct = false;
            }
        },
    };
    
    // High Perceptual and Low Reward Uncertainty
    var s0_r1_high90 = {
        type: 'canvas-keyboard-response',
        on_start: function(s0_r1_high90){
            s0_r1_high90.contrast = Math.random(); s0_r1_high90.contrast1 = jsPsych.currentTrial().contrast  + randbet(0.05,0.35);
        },
        stimulus: gabor,
        data: { condition: 'HL', state: '0', reward: '1', prob: '90_10'},
        choices: keys, trial_duration: duration, response_ends_trial: false,
        on_finish: function (data) {
            if (data.key_press === rand90r1.pop()) {
                data.correct = true;
            } else {
                data.correct = false;
            }
        },
    };
    
    // High Perceptual and Low Reward Uncertainty
    var s1_r2_low60 = {
        type: 'canvas-keyboard-response',
        on_start: function(s1_r2_low60){
            s1_r2_low60.contrast = Math.random(); s1_r2_low60.contrast1 = jsPsych.currentTrial().contrast  - randbet(0.5,0.9);
        },
        stimulus: gabor,
        data: {condition: 'LH', state: '1', reward: '2', prob: '40_60',},
        choices: keys, trial_duration: duration, response_ends_trial: false,
        on_finish: function (data) {
            if (data.key_press === rand60r2_3.pop()) {
                data.correct = true;
            } else {
                data.correct = false;
            }
        },
    };
     
    // Low Perceptual and Reward Uncertainty
    var s1_r2_low90 = {
        type: 'canvas-keyboard-response',
        on_start: function(s1_r2_low90){
            s1_r2_low90.contrast = Math.random(); s1_r2_low90.contrast1 = jsPsych.currentTrial().contrast  - randbet(0.5,0.9);
        },
        stimulus: gabor,
        data: {condition: 'LL', state: '1', reward: '2', prob: '10_90'},
        choices: keys, trial_duration: duration, response_ends_trial: false,
        on_finish: function (data) {
            if (data.key_press === rand90r2_3.pop()) {
                data.correct = true;
            } else {
                data.correct = false;
            }
        },
    };
    
    //trial structure with fixation, stimulus, and feedback
    var s0_r1_hh60 = {
        timeline: [fix, s0_r1_high60, fb], repetitions: 1, randomize_order: true
    };
    var s0_r1_hl90 = {
        timeline: [fix, s0_r1_high90, fb], repetitions: 1, randomize_order: true
    };
    var s1_r2_hl60 = {
        timeline: [fix, s1_r2_low60, fb], repetitions: 1, randomize_order: true
    };
    var s1_r2_ll90 = {
        timeline: [fix, s1_r2_low90, fb], repetitions: 1, randomize_order: true
    };
    
    //start and practice blocks
    timeline.push(welcome);
    timeline.push(highprac_instruct);
    timeline.push(prac_block);
    timeline.push(practice_block);
    timeline.push(lowprac_instruct);
    timeline.push(prac_block);
    timeline.push(practice_block);
    
    //Experimental Blocks
    timeline.push(instructions);
    timeline.push(block1);
    timeline.push(s0_r1_hh60);
    timeline.push(block1);
    timeline.push(s0_r1_hl90);
    timeline.push(block1);
    timeline.push(s1_r2_hl60);
    timeline.push(block1);
    timeline.push(s1_r2_ll90);
</script>
